<html>

<!doctype html>
<title>Pronto Stories</title>
<head>
<form action="{{ url_for('get_map') }}" method=post class=addstudy>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
  <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
  <script src={{ url_for('static', filename='stations.js') }}></script>
    <meta charset='utf-8' />
    <link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet-0.7/leaflet.css' />
    <script src='http://d3js.org/d3.v3.min.js' type='text/javascript'></script>
    <script src='http://cdn.leafletjs.com/leaflet-0.7/leaflet.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.2/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.2/mapbox.css' rel='stylesheet' />
    <script src='https://code.jquery.com/jquery-1.11.3.js'></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
    <link rel="stylesheet" type=text/css href="{{ url_for('static', filename='style.css') }}">
    </head>
  <nav class="navbar navbar-custom navbar-fixed-top">
      <div class="container">
          <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                      <span class="sr-only">Toggle navigation</span>

                          <span class="icon-bar"></span>
                          <span class="icon-bar"></span>
                          <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" style="padding: 2px 0 0 0px;" href="#"><img src="http://www.prontocycleshare.com/assets/images/logos/logo.png" /></a>
                      </div>
                      <div id="navbar" class="collapse navbar-collapse">
                        <ul class="nav navbar-nav">
                          <li class="active" style="font-size:42px;" ><a href="#">STORIES</a></li>
                        </ul>
                      </div><!--/.nav-collapse -->
                    </div>
                  </nav>

<body>
  <div id='demo' class='col-xs-6'>
    <p>
    {% for entry in entries %}
    Trip start: {{ entry.station_start }}</br>
    Trip ending at: {{ entry.station_end }}</br>
    Total number of riders: {{ entry.ntrips }}</br>
    Rank out of all possible routes: {{ entry.routerank }}
    {% endfor %}
    </p>
</div>

<div id='map' class='col-xs-6' style="width: 900px; height: 1000px"></div>
<script type='text/javascript'>

//var div = document.getElementById('demo');
//div.innerHTML = div.innerHTML + 'Extra stuff';


L.mapbox.accessToken = 'pk.eyJ1Ijoic3RlZHkiLCJhIjoiUU9kOC1xcyJ9.xmKXVS0kLIjF5hR6rBzTCw';
    map = L.mapbox.map('map', 'mapbox.streets')
          .setView([47.6031447,-122.3285673], 13);
    var svg = d3.select(map.getPanes().overlayPane).append('svg');
    var g = svg.append('g').attr('class', 'leaflet-zoom-hide');
    var infile = '{{ infile }}'

    d3.json("{{ url_for('static', filename=infile) }}", function(collection) {

        // this is not needed right now, but for future we may need
        // to implement some filtering. This uses the d3 filter function
        // featuresdata is an array of point objects

var featuresdata = collection.features.filter(function(d) {
    return d.properties.id == '{{ route }}'
        })
        //stream transform. transforms geometry before passing it to
        // listener. Can be used in conjunction with d3.geo.path
        // to implement the transform.

        var transform = d3.geo.transform({
            point: projectPoint
        });

        var d3path = d3.geo.path().projection(transform);

        var toLine = d3.svg.line()
            .interpolate('linear')
            .x(function(d) {
                return applyLatLngToLayer(d).x
            })
            .y(function(d) {
                return applyLatLngToLayer(d).y
            });

        var ptFeatures = g.selectAll('circle')
            .data(featuresdata)
            .enter()
            .append('circle')
            .attr('class', 'waypoints');

        var linePath = g.selectAll('.lineConnect')
            .data([featuresdata])
            .enter()
            .append('path')
            .attr('class', 'lineConnect');

        // This will be our traveling circle it will
        // travel along our path
        var marker = g.append('circle')
            .attr('id', 'marker')
            .attr('class', 'travelMarker');

        var originANDdestination = [featuresdata[0], featuresdata[featuresdata.length - 1]]

        var begend = g.selectAll('.drinks')
            .data(originANDdestination)
            .enter()
            .append('circle', '.drinks')
            .style('opacity', '1');
        map.on('viewreset', reset);

        reset();
        transition();

        // Reposition the SVG to cover the features.
        function reset() {
            var bounds = d3path.bounds(collection),
                topLeft = bounds[0],
                bottomRight = bounds[1];

            // for the points we need to convert from latlong
            // to map units
            begend.attr('transform',
                function(d) {
                    return 'translate(' +
                        applyLatLngToLayer(d).x + ',' +
                        applyLatLngToLayer(d).y + ')';
                });

            ptFeatures.attr('transform',
                function(d) {
                    return 'translate(' +
                        applyLatLngToLayer(d).x + ',' +
                        applyLatLngToLayer(d).y + ')';
                });

            // again, not best practice, but I'm harding coding
            // the starting point

            marker.attr('transform',
                function() {
                    var y = featuresdata[0].geometry.coordinates[0]
                    var x = featuresdata[0].geometry.coordinates[1]
                    return 'translate(' +
                        map.latLngToLayerPoint(new L.LatLng(y, x)).x + ',' +
                        map.latLngToLayerPoint(new L.LatLng(y, x)).y + ')';
                });


            // Setting the size and location of the overall SVG container
            svg.attr('width', bottomRight[0] - topLeft[0] + 120)
                .attr('height', bottomRight[1] - topLeft[1] + 120)
                .style('left', topLeft[0] - 50 + 'px')
                .style('top', topLeft[1] - 50 + 'px');

            // linePath.attr('d', d3path);
            linePath.attr('d', toLine)
            g.attr('transform', 'translate(' + (-topLeft[0] + 50) + ',' + (-topLeft[1] + 50) + ')');

        } // end reset

        function transition() {
            linePath.transition()
                .duration(7500)
                .attrTween('stroke-dasharray', tweenDash)
        }

        function tweenDash() {
            return function(t) {
                //total length of path (single value)
                var l = linePath.node().getTotalLength(); 
                interpolate = d3.interpolateString('0,' + l, l + ',' + l);
                var marker = d3.select('#marker');
                var p = linePath.node().getPointAtLength(t * l);

                //Move the marker to that point
                marker.attr('transform', 'translate(' + p.x + ',' + p.y + ')'); //move marker
                console.log(interpolate(t))
                return interpolate(t);
            }
        }

        function projectPoint(x, y) {
            var point = map.latLngToLayerPoint(new L.LatLng(x,y));
            this.stream.point(point.x, point.y);
        } //end projectPoint
    });

    function applyLatLngToLayer(d) {
        var y = d.geometry.coordinates[0]
        var x = d.geometry.coordinates[1]
        return map.latLngToLayerPoint(new L.LatLng(y, x))


    }
    </script>
  </div>
  </body>

</html>
